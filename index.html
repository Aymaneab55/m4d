<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GameVault+ | Premium Mobile Games</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --primary:#8a2be2;
      --secondary:#00bfff;
      --accent:#ff4081;
      --background:#0f0c29;
      --surface:#1a1647;
      --surface-light:#2a2463;
      --text-primary:#f8f9fa;
      --text-secondary:#b0b8d0;
      --text-muted:#8a94b0;
      --border:#2a2463;
      --shadow:rgba(0,0,0,0.35);
      --card-shadow:0 6px 15px rgba(0,0,0,0.12);
      --glow:0 0 12px rgba(138,43,226,0.18);
      --gradient-primary:linear-gradient(135deg,var(--primary),var(--secondary));
      --gradient-surface:linear-gradient(145deg,var(--surface),var(--background));
      --gradient-hero:linear-gradient(135deg, rgba(15,12,41,0.95) 0%, rgba(26,22,71,0.95) 100%);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html{font-size:14px}
    body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,var(--background) 0%,#1a1a2e 100%);color:var(--text-primary);-webkit-text-size-adjust:100%}

    /* Header / Hero */
    .hero{background:var(--gradient-hero),url('https://images.unsplash.com/photo-1550745165-9bc0b252726f?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80');background-size:cover;background-position:center;padding:1.2rem 1rem 1.8rem;text-align:center;border-bottom:1px solid var(--border)}
    .logo{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:.8rem;margin-top:.3rem}
    .logo-icon{width:36px;height:36px;background:var(--gradient-primary);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1rem;box-shadow:var(--glow)}
    .logo-text{font-family:'Rajdhani',sans-serif;font-size:1.4rem;font-weight:700;background:linear-gradient(135deg,var(--text-primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .tagline{font-size:.9rem;color:var(--text-secondary);margin-bottom:1rem;padding:0 .5rem}
    .value-props{display:flex;flex-direction:column;gap:.6rem;margin:1.2rem 0;align-items:center}
    .value-prop{display:flex;align-items:center;gap:.5rem;color:var(--text-secondary);font-size:.8rem;padding:.4rem .8rem;border-radius:16px;background:rgba(255,255,255,0.05)}
    .search-container{display:flex;justify-content:center;margin:1.2rem auto;padding:0 .5rem}
    .search-wrapper{position:relative;max-width:400px;width:100%}
    #searchInput{padding:.8rem .8rem .8rem 2.5rem;width:100%;border-radius:10px;border:1px solid var(--border);background:rgba(26,22,71,0.7);color:var(--text-primary)}
    .search-icon{position:absolute;left:.9rem;top:50%;transform:translateY(-50%);color:var(--text-muted)}
    .cta-btn{background:var(--gradient-primary);border:none;padding:.8rem 1.8rem;border-radius:10px;color:#fff;font-weight:600;display:inline-flex;align-items:center;gap:.5rem;box-shadow:0 5px 15px var(--shadow)}

    .games-section{padding:1.5rem 1rem;max-width:1200px;margin:0 auto}
    .section-header{text-align:center;margin-bottom:1.5rem}
    .section-title{font-family:'Rajdhani',sans-serif;font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,var(--text-primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .section-subtitle{color:var(--text-secondary);font-size:.9rem;max-width:600px;margin:0 auto}

    /* Grid: 2 (small) - 2 (mid) - 3 (large) */
    .games-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.9rem;margin-top:1.2rem}

    .game-card{background:var(--gradient-surface);border-radius:12px;padding:.8rem;border:1px solid var(--border);position:relative;overflow:hidden;display:flex;flex-direction:column;align-items:center;min-height:150px;box-shadow:var(--card-shadow);cursor:pointer}
    .game-card::before{content:"";position:absolute;top:0;left:0;right:0;height:2px;background:var(--gradient-primary)}
    .game-logo-container{width:70px;height:70px;border-radius:14px;overflow:hidden;margin-bottom:.8rem;display:flex;align-items:center;justify-content:center;border:2px solid var(--primary);background:rgba(255,255,255,0.05)}
    .game-logo{width:100%;height:100%;object-fit:contain;padding:5px;display:block}
    .game-info{flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;width:100%}
    .game-title{font-size:.8rem;font-weight:700;color:var(--text-primary);line-height:1.2;margin-bottom:.4rem;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .game-version{font-size:.7rem;color:var(--accent);font-weight:600;background:rgba(255,64,129,0.1);padding:.25rem .5rem;border-radius:6px}

    /* Modal / Locker base */
    .modal-overlay, .locker-overlay{display:none;position:fixed;inset:0;z-index:1000;justify-content:center;align-items:center;padding:1rem;backdrop-filter:blur(6px);background:rgba(15,12,41,0.92)}
    .platform-modal{width:100%;max-width:560px;background:var(--gradient-surface);border-radius:12px;padding:1rem;border:1px solid var(--border);box-shadow:0 14px 30px rgba(0,0,0,0.35),var(--glow);text-align:center;position:relative}
    .close-btn{position:absolute;right:12px;top:12px;width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.06);border:none;color:var(--text-muted);cursor:pointer}
    .close-btn:hover{background:rgba(255,255,255,0.12);color:var(--text-primary)}

    /* Modal thumbnail: uses background-image fallback (works even when CORS blocks canvas) */
    .platform-modal .game-box-thumbnail{
      width:96px;
      height:96px;
      border-radius:12px;
      overflow:hidden;
      margin:0 auto .75rem;
      display:flex;
      align-items:center;
      justify-content:center;
      background:var(--gradient-primary);
      padding:10px;
      box-shadow:none;
      transition:transform .18s ease, opacity .18s ease;
      transform:translateY(0);
      opacity:1;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
    }
    /* image element kept as accessibility/fallback but visually we rely on background */
    .platform-modal .game-box-thumbnail img.modal-logo{
      display:block;
      width:auto;
      height:auto;
      max-width:72%;
      max-height:72%;
      object-fit:contain;
      border-radius:8px;
      background:transparent;
      box-shadow:none;
      border:none;
      transition:transform .22s cubic-bezier(.2,.9,.3,1), opacity .22s;
      transform: scale(.95);
      opacity: 0;
    }
    .platform-modal.show .game-box-thumbnail img.modal-logo{
      transform: scale(1);
      opacity: 1;
    }

    .platform-modal h2{font-size:1.08rem;color:var(--text-primary);margin:.25rem 0}
    .platform-modal p{color:var(--text-secondary);font-size:.95rem;margin-bottom:.6rem}
    .platform-buttons{display:flex;flex-direction:column;gap:.6rem}
    .platform-btn{background:var(--gradient-primary);border:none;padding:.72rem;border-radius:10px;color:#fff;font-weight:700;cursor:pointer;font-size:.98rem;box-shadow:0 4px 10px rgba(138,43,226,0.16)}

    /* Locker styling */
    .locker-box{width:100%;max-width:520px;background:var(--gradient-surface);border-radius:12px;padding:.9rem;border:1px solid var(--border);box-shadow:0 14px 30px rgba(0,0,0,0.35),var(--glow);color:var(--text-primary);position:relative}
    .locker-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.6rem;padding-bottom:.4rem;border-bottom:1px solid var(--border)}
    .locker-logo{display:flex;align-items:center;gap:.4rem;color:var(--primary);font-weight:700;font-size:.9rem}
    .locker-close-btn{position:absolute;right:10px;top:10px;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.06);border:none;color:var(--text-muted);cursor:pointer}
    .locker-close-btn:hover{background:rgba(255,255,255,0.12);color:var(--text-primary)}

    .game-preview-locker{display:flex;align-items:center;gap:.9rem;margin-bottom:.6rem;background:transparent;padding:.4rem;border-radius:8px}
    .game-preview-locker .game-box-thumbnail.small{
      width:92px;
      height:92px;
      border-radius:10px;
      background:transparent;
      box-shadow:none;
      margin:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .game-preview-locker img{width:auto !important;height:auto !important;max-width:100%;max-height:100%;object-fit:contain;border-radius:0;background:transparent;border:none}

    /* Centered verification block (user requested) */
    .locker-center{display:flex;flex-direction:column;align-items:center;text-align:center;margin:6px 0 8px;padding:0 8px}
    .locker-center h2{font-size:1rem;color:var(--primary);margin:.25rem 0}
    .locker-center .cta-strong{margin:0 auto}

    .cta-strong{font-size:.88rem;padding:.42rem;border-radius:6px;background:rgba(255,64,129,0.08);color:var(--accent);font-weight:700}

    .progress-container{margin:.7rem 0;background:var(--background);padding:.5rem;border-radius:6px}
    .progress-header{display:flex;justify-content:space-between;font-size:.78rem;color:var(--text-muted);margin-bottom:.3rem}
    .progress-bar{height:6px;background:var(--surface-light);border-radius:6px;overflow:hidden}
    #progressFill{height:100%;width:0;background:linear-gradient(90deg,var(--primary),var(--secondary));transition:width .35s ease}
    #statusMessage{font-weight:700;color:var(--primary);background:rgba(138,43,226,0.06);padding:.38rem;border-radius:6px;font-size:.9rem;margin-top:.36rem;text-align:center}

    .offers-section{margin-top:.8rem}
    .offers-section h3{color:var(--primary);font-size:.95rem;margin-bottom:.45rem;display:flex;align-items:center;gap:.4rem;justify-content:center}
    #offersList{display:flex;flex-direction:column;gap:.45rem}
    .offer-card{background:var(--gradient-surface);padding:.62rem;border-radius:8px;border:1px solid rgba(138,43,226,0.06);display:flex;justify-content:space-between;align-items:center;gap:.5rem;cursor:pointer;font-size:.9rem}
    .offer-title{font-weight:700;color:var(--text-primary);font-size:.9rem}
    .offer-details{font-size:.82rem;color:var(--text-muted);display:flex;gap:.5rem}

    /* Responsive - keep 2 cols mid, 3 on large */
    @media(min-width:480px){ .games-grid{grid-template-columns:repeat(2,1fr)} }
    @media(min-width:768px){ .games-grid{grid-template-columns:repeat(3,1fr)} }

    @media(max-width:480px){
      .platform-modal,.locker-box{max-width:94%;padding:.7rem;border-radius:10px}
      .platform-modal .game-box-thumbnail{width:80px;height:80px;padding:8px}
      .game-preview-locker .game-box-thumbnail.small{width:72px;height:72px}
      .platform-btn{padding:.65rem;font-size:.92rem}
      .offer-card{font-size:.85rem;padding:.52rem}
      #statusMessage{font-size:.84rem;padding:.42rem}
    }
  </style>
</head>
<body>

  <section class="hero">
    <div class="logo">
      <div class="logo-icon"><i class="fas fa-gamepad"></i></div>
      <div class="logo-text">GameVault</div>
    </div>

    <p class="tagline">Download premium mobile games with exclusive content. All games are safe, verified, and regularly updated.</p>

    <div class="value-props">
      <div class="value-prop"><i class="fas fa-shield-check"></i><span>100% Safe & Verified</span></div>
      <div class="value-prop"><i class="fas fa-bolt"></i><span>Regular Updates</span></div>
      <div class="value-prop"><i class="fas fa-star"></i><span>Premium Features</span></div>
    </div>

    <div class="search-container">
      <div class="search-wrapper">
        <i class="fas fa-search search-icon"></i>
        <input id="searchInput" type="text" placeholder="Search for games..." />
      </div>
    </div>

    <button class="cta-btn" onclick="document.getElementById('games').scrollIntoView({behavior:'smooth'})">
      <i class="fas fa-rocket"></i> Explore Premium Games
    </button>
  </section>

  <section class="games-section" id="games">
    <div class="section-header">
      <h2 class="section-title">Premium Game Collection</h2>
      <p class="section-subtitle">Hand-picked games with enhanced features and exclusive content</p>
    </div>

    <div class="games-grid" id="gamesGrid"></div>
  </section>

  <!-- Platform modal -->
  <div id="platformModal" class="modal-overlay" aria-hidden="true">
    <div class="platform-modal" role="dialog" aria-modal="true" aria-labelledby="modalGameTitle">
      <button class="close-btn" onclick="closePlatformModal()" aria-label="Close">√ó</button>

      <!-- The thumbnail container supports a background-image fallback (used to display logos reliably) -->
      <div class="game-box-thumbnail" id="modalThumbnail">
        <img id="modalGameImg" class="modal-logo" src="" alt="Game Logo" decoding="async" loading="eager" />
      </div>

      <h2 id="modalGameTitle">Select Platform</h2>
      <p>Choose your device platform to continue</p>

      <div class="platform-buttons">
        <button class="platform-btn" id="androidBtn"><i class="fab fa-android"></i> Android</button>
        <button class="platform-btn" id="iosBtn"><i class="fab fa-apple"></i> iOS</button>
      </div>
    </div>
  </div>

  <!-- Locker -->
  <div id="locker" class="locker-overlay" aria-hidden="true">
    <div class="locker-box" role="dialog" aria-modal="true">
      <button class="locker-close-btn" onclick="closeLocker()" aria-label="Close locker">√ó</button>

      <div class="locker-header">
        <div class="locker-logo">
          <i class="fas fa-shield-alt"></i>
          <span>GameVault+ Secure Download</span>
        </div>
      </div>

      <div class="game-preview-locker" id="gamePreviewLocker"></div>

      <div class="locker-center" id="lockerCenter">
        <h2 id="lockerTitle">Items Verification</h2>
        <p class="cta-strong" id="lockerInstruction">Complete one quick offer to unlock your download + exclusive bonus content!</p>
      </div>

      <div class="progress-container">
        <div class="progress-header">
          <span>Security Check</span>
          <span id="progressPercent">0%</span>
        </div>
        <div class="progress-bar"><div id="progressFill"></div></div>
        <div style="display:flex;justify-content:space-between;color:var(--text-muted);font-size:.82rem;margin-top:.32rem">
          <span>Preparing download...</span>
          <span>Secure</span>
        </div>
      </div>

      <p id="statusMessage">üîÑ Initializing secure download...</p>

      <div id="offersSection" class="offers-section" style="display:none">
        <h3><i class="fas fa-gift"></i> Choose Your Offer</h3>
        <div id="offersList"></div>

        <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.6rem;justify-content:center">
          <div style="display:flex;align-items:center;gap:.35rem;color:var(--text-muted);font-size:.85rem"><i class="fas fa-shield-check" style="color:var(--primary)"></i><span>100% Secure</span></div>
          <div style="display:flex;align-items:center;gap:.35rem;color:var(--text-muted);font-size:.85rem"><i class="fas fa-clock"></i><span>1-3 Minutes</span></div>
          <div style="display:flex;align-items:center;gap:.35rem;color:var(--text-muted);font-size:.85rem"><i class="fas fa-download"></i><span>Instant Access</span></div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer" style="background:var(--gradient-surface);padding:1.2rem 1rem;margin-top:1.2rem;border-top:1px solid var(--border)">
    <div style="max-width:1200px;margin:0 auto;display:flex;flex-direction:column;align-items:center;gap:.8rem">
      <div style="display:flex;align-items:center;gap:.6rem">
        <div class="logo-icon" style="width:30px;height:30px"><i class="fas fa-gamepad"></i></div>
        <div style="font-family:'Rajdhani',sans-serif;font-weight:700">GameVault</div>
      </div>
      <div style="display:flex;gap:1rem;flex-wrap:wrap;justify-content:center">
        <a class="footer-link" href="#">Privacy Policy</a>
        <a class="footer-link" href="#">Terms of Service</a>
        <a class="footer-link" href="#">Contact Us</a>
        <a class="footer-link" href="#">About</a>
      </div>
    </div>
    <div style="text-align:center;margin-top:.7rem;color:var(--text-muted);font-size:.85rem">&copy; 2023 GameVault+. All rights reserved. Partnered with Doublemedia CPA.</div>
  </footer>

  <script>
    // Game data
    const games = [
      { title: "BeamNG.drive Mobile", img: "https://avatars.githubusercontent.com/u/6404024?s=280&v=4", version: "v0.32.0.0" },
      { title: "Dispatch Mobile", img: "https://i.postimg.cc/QNc8k2D9/Dispatch-art-jpg.webp", version: "v1.5.2" },
      { title: "Am a Monkey (No Ads", img: "https://i.postimg.cc/Qx3V7hRX/Untitled-design-1.png", version: "v1.0.4" },
      { title: "GTA V Mobile", img: "https://i.pinimg.com/736x/8f/01/03/8f010359c57da7850e723fa17a53b55e.jpg", version: "v1.0.3095/1.68" },
      { title: "8 Ball Pool Aimbot MOD", img: "https://www.latestmodapks.com/wp-content/uploads/2022/10/com.miniclip.eightballpool.jpg", version: "v5.15.2" },
      { title: "Gorilla Tag Mobile", img: "https://img.tapimg.net/market/images/181c7a899a46a98dd93d07da84847a5f.jpg", version: "v1.2.5" },
      { title: "Forza Horizon Mobile", img: "https://images.seeklogo.com/logo-png/40/1/forza-horizon-5-logo-png_seeklogo-406612.png", version: "v2.0.1" },
      { title: "Euro Truck Simulator 2", img: "https://i.pinimg.com/564x/32/ae/e5/32aee5919f1c4e81da58627d21b3323a.jpg", version: "v1.48.2" },
      { title: "Hitman: Absolution Mobile", img: "https://play-lh.googleusercontent.com/sZ2vcnPx2dGILYDxX4e6VIFZq1lWdBvekVFSGphJa2Lnreo7ghXsaP11nIKq77Rl775JN6zgf7v9whOmKwpWMoY", version: "v3.14.1" },
      { title: "Rooftops & Alleys", img: "https://i.postimg.cc/W1bm7TRt/Fh-T2ixl-Wyl9-TPswg-KLF0j-Pp9j-Nuq.png", version: "v2.3.0" },
      { title: "Fortnite Mobile", img: "https://pbs.twimg.com/media/GxGV7xRXMAAPHh0.jpg", version: "v27.10.0" },
      { title: "WWE 2K25 Mobile", img: "https://play-lh.googleusercontent.com/uD9hXMYt6fqwiSnTd6vqj0pi5JfTvIHbZR9OFllSPcuG_V1iGwNOJ26wwXd1b0z89zp-=w240-h480-rw", version: "v1.5.0" },
      { title: "Project Brutality Doom", img: "https://static.doomworld.com/monthly_2023_06/51f3b0e3dcd1cf493fe29ac632aeec39.jpg.88231b2c110b31f13555d274b67c763e.jpg", version: "v0.1.0" },
      { title: "Highway Racer Pro", img: "https://play-lh.googleusercontent.com/hNugD_lGLRZAWnEss_Ue66J2NH2M2rNLJODh8Bpr8EGyOYZe05epjQ3EK2WdtmJsOoc", version: "v4.5.1" },
      { title: "CarX Street", img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR4pqJlpezWAKhl0bwwWy1GIc_zVOGXjHvz9Q&amp;s", version: "v1.2.3" },
      { title: "Baseball 9 Mod", img: "https://i.postimg.cc/j254nVy3/e21d66a4-4e0a-4a5b-9521-397d4cb5d383.png", version: "v3.8.0" },
      { title: "Hollow Knight Mobile", img: "https://i.postimg.cc/Vvj4G8nC/icon.webp", version: "v1.5.78" },
      { title: "Speed Stars", img: "https://i.postimg.cc/q7LSqhJv/Hard.png", version: "v2.1.0" },
      { title: "Lamar Idle Vlogger", img: "https://i.postimg.cc/RFv1XQFq/Lamar-Idle-Vlogger-Mod-APK.webp", version: "v1.4.2" },
      { title: "Snake Clash", img: "https://i.postimg.cc/ZqFX5FJT/71dded537746e75207450ca40f71d089ff02df7c47300f91f5a7522ec910bdc3_200.webp", version: "v3.7.1" },
      { title: "Racing Ultimate", img: "https://images.unsplash.com/photo-1551103782-8ab07afd45c1?ixlib=rb-4.0.3&auto=format&fit=crop&w=200&q=80", version: "v2.0.5" }
    ];

    let currentGame = null;
    let currentPlatform = null;
    let progressInterval = null;

    // AdBlue credentials (kept)
    const ADBLUE_USER_ID = 504359;
    const ADBLUE_API_KEY = "3b17a09c1ca2bba2d52ffadab4894374";

    document.addEventListener('DOMContentLoaded', () => {
      renderGames();
      attachListeners();
    });

    function renderGames(){
      const grid = document.getElementById('gamesGrid');
      grid.innerHTML = '';
      games.forEach((g,i) => {
        const el = document.createElement('div');
        el.className = 'game-card';
        el.dataset.index = i;
        el.innerHTML = `
          <div class="game-logo-container">
            <img class="game-logo" src="${g.img}" alt="${escapeHtml(g.title)}" loading="lazy" />
          </div>
          <div class="game-info">
            <h3 class="game-title">${escapeHtml(g.title)}</h3>
            <div class="game-version">${escapeHtml(g.version)}</div>
          </div>
        `;
        grid.appendChild(el);
      });
    }

    function attachListeners(){
      document.getElementById('gamesGrid').addEventListener('click', (ev) => {
        const card = ev.target.closest('.game-card');
        if(!card) return;
        openPlatformModal(parseInt(card.dataset.index,10));
      });

      document.getElementById('androidBtn').addEventListener('click', () => selectPlatform('android'));
      document.getElementById('iosBtn').addEventListener('click', () => selectPlatform('ios'));

      document.getElementById('searchInput').addEventListener('input', () => {
        const q = document.getElementById('searchInput').value.toLowerCase();
        document.querySelectorAll('.game-card').forEach(card => {
          const title = card.querySelector('.game-title').textContent.toLowerCase();
          card.style.display = title.includes(q) ? 'flex' : 'none';
        });
      });

      // Close modals with Escape for convenience
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape'){
          if(document.getElementById('platformModal').style.display === 'flex') closePlatformModal();
          if(document.getElementById('locker').style.display === 'flex') closeLocker();
        }
      });
    }

    // attempt auto-crop normalization (works when CORS allows)
    function normalizeImage(src, maxSize = 800){
      return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          try {
            const scale = Math.min(1, maxSize / Math.max(img.width, img.height));
            const w = Math.round(img.width * scale);
            const h = Math.round(img.height * scale);
            const c = document.createElement('canvas');
            c.width = w; c.height = h;
            const ctx = c.getContext('2d');
            ctx.drawImage(img,0,0,w,h);
            const d = ctx.getImageData(0,0,w,h).data;
            const getPx = (x,y)=>{ const i=(y*w+x)*4; return [d[i],d[i+1],d[i+2],d[i+3]]; };
            const corners = [getPx(0,0), getPx(w-1,0), getPx(0,h-1), getPx(w-1,h-1)];
            const avg = corners.reduce((a,c)=>{a[0]+=c[0];a[1]+=c[1];a[2]+=c[2];return a},[0,0,0]).map(v=>v/4);
            const tol = 18;
            const similar = px => Math.abs(px[0]-avg[0])<=tol && Math.abs(px[1]-avg[1])<=tol && Math.abs(px[2]-avg[2])<=tol;
            let top=0,bottom=h-1,left=0,right=w-1;
            outer: for(let y=0;y<h;y++){ for(let x=0;x<w;x++){ if(!similar(getPx(x,y))){ top=y; break outer; } } }
            outer2: for(let y=h-1;y>=0;y--){ for(let x=0;x<w;x++){ if(!similar(getPx(x,y))){ bottom=y; break outer2; } } }
            outer3: for(let x=0;x<w;x++){ for(let y=0;y<h;y++){ if(!similar(getPx(x,y))){ left=x; break outer3; } } }
            outer4: for(let x=w-1;x>=0;x--){ for(let y=0;y<h;y++){ if(!similar(getPx(x,y))){ right=x; break outer4; } } }
            if(right-left < 6 || bottom-top < 6) { resolve(src); return; }
            const cw = right-left+1, ch = bottom-top+1;
            const out = document.createElement('canvas'); out.width = cw; out.height = ch;
            out.getContext('2d').drawImage(c, left, top, cw, ch, 0,0,cw,ch);
            resolve(out.toDataURL('image/png'));
          } catch(e){ resolve(src); }
        };
        img.onerror = () => resolve(src);
        img.src = src;
        if(img.complete) setTimeout(()=>{ if(img.naturalWidth) img.onload(); },10);
      });
    }

    // Robust modal image handling plus reliable background-image fallback (fixes logos that fail to show due to CORS)
    function openPlatformModal(index){
      const game = games[index];
      currentGame = game;
      const modalThumb = document.getElementById('modalThumbnail');
      const modalImg = document.getElementById('modalGameImg');
      const modalWrap = modalThumb.closest('.platform-modal');

      // reset states
      modalWrap.classList.remove('show');
      modalImg.onload = null;
      modalImg.onerror = null;
      modalImg.src = '';
      modalImg.alt = game.title;
      modalImg.style.display = ''; // ensure visible if previously hidden
      modalThumb.style.backgroundImage = ''; // clear any previous bg

      // Attach handlers BEFORE setting src
      modalImg.onload = () => {
        // if the <img> loads successfully, use it (still keep background-image cleared)
        modalImg.style.width = 'auto';
        modalImg.style.height = 'auto';
        modalImg.style.maxWidth = '72%';
        modalImg.style.maxHeight = '72%';
        // animate image in
        setTimeout(()=> modalWrap.classList.add('show'), 30);
      };

      modalImg.onerror = () => {
        // If <img> fails (often due to CORS when we tried to use dataURL), fall back to using background-image on the container
        // This renders reliably even if remote server doesn't allow crossOrigin canvas access.
        modalImg.style.display = 'none';
        modalThumb.style.backgroundImage = `url("${game.img}")`;
        modalThumb.style.backgroundSize = 'contain';
        modalThumb.style.backgroundPosition = 'center';
        modalThumb.style.backgroundRepeat = 'no-repeat';
        // still show modal and animate
        setTimeout(()=> modalWrap.classList.add('show'), 30);
      };

      // Primary attempt: use normalized/cropped data URL (if allowed). normalizeImage resolves to either dataURL or original src.
      normalizeImage(game.img, 800).then(norm => {
        // If normalizeImage returns the original URL, we still let the <img> handle load.
        modalImg.src = norm || game.img;
      }).catch(() => {
        // If normalization throws, just set the direct image URL
        modalImg.src = game.img;
      });

      // Safety: show modal quickly even if image takes time
      setTimeout(()=> {
        document.getElementById('platformModal').style.display = 'flex';
        // ensure modal is shown even if image loads slowly
        if(!modalWrap.classList.contains('show')) modalWrap.classList.add('show');
      }, 120);

      document.getElementById('modalGameTitle').textContent = game.title;
      document.body.style.overflow = 'hidden';
    }

    function closePlatformModal(){
      const modalImg = document.getElementById('modalGameImg');
      const modalThumb = document.getElementById('modalThumbnail');
      const modalWrap = modalThumb.closest('.platform-modal');

      modalWrap.classList.remove('show');
      // clear handlers & src/background
      modalImg.onload = null;
      modalImg.onerror = null;
      modalImg.src = '';
      modalImg.alt = '';
      modalImg.style.display = '';
      modalThumb.style.backgroundImage = '';
      document.getElementById('platformModal').style.display = 'none';
      document.body.style.overflow = '';
    }

    function selectPlatform(platform){
      currentPlatform = platform;
      closePlatformModal();
      openLocker();
    }

    function openLocker(){
      if(!currentGame || !currentPlatform) return;
      document.getElementById('locker').style.display = 'flex';
      document.body.style.overflow = 'hidden';
      document.getElementById('offersSection').style.display = 'none';
      document.getElementById('progressFill').style.width = '0%';
      document.getElementById('progressPercent').textContent = '0%';
      document.getElementById('statusMessage').textContent = 'üîÑ Initializing secure download...';

      document.getElementById('lockerTitle').textContent = 'Items Verification';
      document.getElementById('lockerInstruction').textContent = 'Complete one quick offer to unlock your download + exclusive bonus content!';

      const preview = document.getElementById('gamePreviewLocker');
      preview.innerHTML = '';

      const thumb = document.createElement('div');
      thumb.className = 'game-box-thumbnail small';
      thumb.style.backgroundImage = ''; thumb.style.backgroundColor = 'transparent';

      const img = document.createElement('img');
      img.className = 'modal-logo'; img.alt = currentGame.title;
      img.decoding = 'async';
      // styling for preview
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'contain';
      img.style.maxWidth = '100%';
      img.style.maxHeight = '100%';
      img.style.opacity = '0';
      img.style.transform = 'scale(.95)';

      // Load preview robustly. If it fails, use background of the thumb container as fallback.
      img.onload = () => {
        img.style.opacity = '1';
        img.style.transform = 'scale(1)';
      };
      img.onerror = () => {
        if(!img.dataset._fallback){
          img.dataset._fallback = '1';
          img.src = currentGame.img;
          return;
        }
        img.removeAttribute('src');
        img.alt = currentGame.title;
        img.style.display = 'none';
        thumb.style.backgroundImage = `url("${currentGame.img}")`;
        thumb.style.backgroundSize = 'contain';
        thumb.style.backgroundPosition = 'center';
        thumb.style.backgroundRepeat = 'no-repeat';
      };

      normalizeImage(currentGame.img, 600).then(norm=>{
        img.src = norm || currentGame.img;
      }).catch(()=>{ img.src = currentGame.img; });

      thumb.appendChild(img);

      const info = document.createElement('div');
      info.className = 'game-preview-content';
      const platformText = currentPlatform === 'android' ? 'ü§ñ Android' : 'üçé iOS';
      const fileType = currentPlatform === 'android' ? 'APK + OBB Files' : 'IPA File';
      info.innerHTML = `<h3 style="margin:0;font-size:.96rem">${escapeHtml(currentGame.title)}</h3>
        <p class="file-info" style="margin:.25rem 0 .0rem;font-size:.86rem;color:var(--text-muted)">üì¶ ${fileType} ‚Ä¢ ${escapeHtml(currentGame.version)} ‚Ä¢ üïí Updated: Today</p>
        <div style="margin-top:.3rem;display:inline-block;background:var(--primary);color:#fff;padding:.22rem .46rem;border-radius:6px;font-weight:700;font-size:.82rem">${platformText}</div>`;

      preview.appendChild(thumb);
      preview.appendChild(info);

      startOptimizedProgressBar();
    }

    function startOptimizedProgressBar(){
      let currentProgress = 0;
      const fill = document.getElementById('progressFill');
      const percent = document.getElementById('progressPercent');
      const status = document.getElementById('statusMessage');
      const messages = [
        "üîÑ Checking device compatibility...",
        "‚úÖ Scanning for security threats...",
        "üîê Verifying file integrity...",
        "‚ö° Optimizing download speed...",
        "üèÅ Preparing game content..."
      ];
      clearInterval(progressInterval);
      progressInterval = setInterval(() => {
        if(currentProgress >= 100){
          clearInterval(progressInterval);
          fill.style.width = '100%';
          percent.textContent = '100%';
          status.innerHTML = '‚úÖ <strong>Ready! Choose an offer to download</strong>';
          document.getElementById('offersSection').style.display = 'block';
          loadOffers();
        } else {
          currentProgress += 5 + Math.random()*6;
          if(currentProgress > 100) currentProgress = 100;
          fill.style.width = currentProgress + '%';
          percent.textContent = Math.round(currentProgress) + '%';
          const idx = Math.min(Math.floor(currentProgress/20), messages.length-1);
          status.textContent = messages[idx];
        }
      }, 140);
    }

    // Offers (AdBlue)
    function loadOffers(){
      if(!currentGame || !currentPlatform) return;
      const searchTerm = `${currentGame.title} ${currentPlatform}`;
      document.getElementById('offersList').innerHTML = `<p style="color:var(--text-muted);font-size:.9rem">Loading offers...</p>`;
      const apiUrl = `https://dbj3fg9om9jaj.cloudfront.net/public/offers/feed.php?user_id=${ADBLUE_USER_ID}&api_key=${ADBLUE_API_KEY}&s1=${encodeURIComponent(searchTerm)}&s2=${encodeURIComponent(currentPlatform)}`;
      fetch(apiUrl)
        .then(r => { if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
        .then(offers => {
          if(!offers || !Array.isArray(offers) || offers.length===0){ showFallbackOffers(); return; }
          displayOffers(offers);
        })
        .catch(e => { console.error('offers load error',e); showFallbackOffers(); });
    }

    function showFallbackOffers(){
      const fallback = [
        { anchor: "Complete Quick Survey (1-2 minutes)", url: `https://dbj3fg9om9jaj.cloudfront.net/public/offers/click.php?user_id=${ADBLUE_USER_ID}&api_key=${ADBLUE_API_KEY}&offer_id=survey1`, type:'survey' },
        { anchor: "Watch Short Video Ad (45-60 seconds)", url: `https://dbj3fg9om9jaj.cloudfront.net/public/offers/click.php?user_id=${ADBLUE_USER_ID}&api_key=${ADBLUE_API_KEY}&offer_id=video1`, type:'video' },
        { anchor: "Free App Trial (2-3 minutes)", url: `https://dbj3fg9om9jaj.cloudfront.net/public/offers/click.php?user_id=${ADBLUE_USER_ID}&api_key=${ADBLUE_API_KEY}&offer_id=trial1`, type:'trial' },
        { anchor: "Quick Registration (1-2 minutes)", url: `https://dbj3fg9om9jaj.cloudfront.net/public/offers/click.php?user_id=${ADBLUE_USER_ID}&api_key=${ADBLUE_API_KEY}&offer_id=register1`, type:'registration' }
      ];
      displayOffers(fallback);
    }

    function displayOffers(offers){
      const out = [];
      const badges = ["Recommended","Easy","Popular","Quick"];
      offers.slice(0,4).forEach((o,idx) => {
        const timeOptions=[60,90,120,150]; const t=timeOptions[idx]||120;
        const success = 85 + Math.floor(Math.random()*10);
        const users = Math.floor(Math.random()*50000)+20000;
        const url = o.url || `https://dbj3fg9om9jaj.cloudfront.net/public/offers/click.php?user_id=${ADBLUE_USER_ID}&api_key=${ADBLUE_API_KEY}&offer_id=${o.id||'default'}`;
        out.push(`<div class="offer-card" onclick="selectOffer('${url}','${escapeJs(currentGame.title)}','${currentPlatform}','${o.type||'task'}','${escapeJs(o.anchor||'Quick Task')}')">
          <div>
            <div class="offer-title">${escapeHtml(o.anchor||'Complete Quick Task')}</div>
            <div class="offer-details"><span>‚úÖ ${success}%</span><span>‚è± ${Math.floor(t/60)} min</span><span>üë• ${(users/1000).toFixed(0)}K+</span></div>
          </div>
          <div style="background:linear-gradient(90deg,var(--primary),var(--secondary));color:#fff;padding:.32rem .56rem;border-radius:8px;font-weight:800;font-size:.86rem">${badges[idx]||'Special'}</div>
        </div>`);
      });
      document.getElementById('offersList').innerHTML = out.join('');
    }

    // Updated: open offer in new tab, keep locker open, no alert
    function selectOffer(url, gameName, platform, offerType, offerTitle){
      trackAdBlueMediaConversion(gameName, platform, offerType, offerTitle);
      const trackingParams = `&subid=${ADBLUE_USER_ID}_${gameName.replace(/\s+/g,'_')}_${platform}&game=${encodeURIComponent(gameName)}&platform=${platform}&offer_type=${offerType}&source=apkmod`;
      const tracked = url + (url.includes('?') ? '&' : '?') + trackingParams;

      document.getElementById('statusMessage').innerHTML = '‚úÖ <strong>Offer opened in a new tab ‚Äî complete it there to start your download.</strong>';

      if(url && url !== '#') {
        try {
          window.open(tracked, '_blank', 'noopener');
        } catch(e) {
          const a = document.createElement('a');
          a.href = tracked;
          a.target = '_blank';
          a.rel = 'noopener';
          a.click();
        }
      }
      // locker remains open; no alert, no auto-close
    }

    function closeLocker(){
      document.getElementById('locker').style.display = 'none';
      clearInterval(progressInterval);
      document.getElementById('progressFill').style.width = '0%';
      document.getElementById('progressPercent').textContent = '0%';
      document.getElementById('offersList').innerHTML = '';
      document.body.style.overflow = '';
      currentGame = null; currentPlatform = null;
    }

    function trackAdBlueMediaConversion(gameName, platform, offerType, offerTitle){
      const conversionData = { user_id: ADBLUE_USER_ID, api_key: ADBLUE_API_KEY, game: gameName, platform, offer_type: offerType, offer_title: offerTitle, source: 'apkmod', campaign: 'game_download', conversion_type: 'lead', timestamp: Date.now(), revenue: 0.15 };
      const px = `https://dbj3fg9om9jaj.cloudfront.net/public/conversion/pixel.gif?user_id=${ADBLUE_USER_ID}&api_key=${ADBLUE_API_KEY}&game=${encodeURIComponent(gameName)}&platform=${platform}&offer_type=${offerType}&conversion=lead&revenue=0.15`;
      const img = new Image(); img.src = px;
      fetch('https://dbj3fg9om9jaj.cloudfront.net/public/conversion/track.php', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(conversionData) })
        .then(r=>r.json()).then(d=>console.log('conversion response',d)).catch(e=>console.log('conversion error',e));
    }

    function escapeHtml(s){ return (s||'').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
    function escapeJs(s){ return (s||'').toString().replace(/'/g,"\\'").replace(/"/g,'\\"'); }
  </script>
</body>
</html>
